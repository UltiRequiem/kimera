name: Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        go: ["1.17"]
    name: Go ${{ matrix.go }} test
    steps:
      - uses: actions/checkout@v2
      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
      - name: Build kimera
        run: go build -o kimera
      - name: Run test suite
        run: |
          echo "Running test suite..."
          test_failed=0
          
          # Helper function to run a test with specific flags
          run_test() {
            local file=$1
            shift
            local flags="$@"
            echo "=== Running $file $flags ==="
            if ./kimera run "$file" $flags; then
              echo "✓ $file passed"
            else
              echo "✗ $file failed"
              test_failed=1
            fi
            echo ""
          }
          
          # Helper function to run all tests in a directory with specific flags
          run_directory_tests() {
            local dir=$1
            shift
            local flags="$@"
            
            if [ -d "$dir" ]; then
              echo "Running tests in $dir with flags: $flags"
              for test_file in "$dir"/*.js "$dir"/*.ts; do
                if [ -f "$test_file" ]; then
                  run_test "$test_file" $flags
                fi
              done
            fi
          }
          
          # Run tests by directory with appropriate permissions
          run_directory_tests "testings/fs" --fs
          run_directory_tests "testings/net" --net
          run_directory_tests "testings/env" --env
          run_directory_tests "testings/combined" --fs --env
          run_directory_tests "testings/basic"
          
          if [ $test_failed -eq 1 ]; then
            echo "Some tests failed!"
            exit 1
          fi
          echo "All tests passed!"
